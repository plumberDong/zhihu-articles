#! https://zhuanlan.zhihu.com/p/491777213
# 建模的思路与方法(以R为例)

最近，网上一张关于上海疫情预测的图片火了。作者用指数增长模型拟合了上海感染人数的增长曲线，并以相当高的准确性预测了后续几天的疫情增长情况。

事实上，在研究和生活中，通过建模来分析和预测现象是一个强力且有趣的手段，然而，到底应该选择哪些模型，合理的建模思路是怎样的，何时以及为什么需要对数据做变换，这些更为基础且关键的东西，在学校却很少学到。

这是因为，教学更关注的是技术方法和模型的数学细节，特别是社会统计课上，太多的精力放在了估计性质以及标准误上，对模型本身的理解存在一定缺位。这导致我们从复杂的“模型空间”做选择时，往往显得无所适从。

最近看到一篇很不错的[博文](https://www.magesblog.com/post/modelling-change/)，是关于社会科学的统计建模的。该文以浅显易懂的方式展示了一个建模的完整思路流程，既有理论，也有实操。本文是对该文的一个转述及拓展。除了包含其核心论述外，还会对R语言代码、数学公式作一些补充。

## 从冰淇凌销量谈起

假设有家甜品店的老板找到我们，给了我们一份数据，内容是12个不同温度下冰淇凌的销量。

```S
ice_cream <- tibble(
  temp=c(11.9, 14.2, 15.2, 16.4, 17.2, 18.1, 
         18.5, 19.4, 22.1, 22.6, 23.4, 25.1),
  units=c(185L, 215L, 332L, 325L, 408L, 421L, 
          406L, 412L, 522L, 445L, 544L, 614L)
  )
```

![Fig.1 不同气温下冰淇凌的销量](https://pic4.zhimg.com/80/v2-9e8a3ccc28d16d649b3798be7b7d5517.png)

老板希望获得一个输入气温后就可以得到销量的模型，这样根据天气预报，就能预测未来几天的销售情况，从而为库存管理提供参考。

## 关于建模

模型的本质，就是对变化规则的刻画。在这单业务中，我们要做的就是概括销量随气温的变化规则。

在数学中，描述变化最常用的技巧是微分方程。在下文中，我将不断使用微分方程作为思考的起点，去描述我们对于变化规则的几种假设。

## 假设1:无变化

对于销量如何随气温变化，最简单的假设就是没有变化，即所有气温下的销量的期望都一样。该假设可以写成一个常微分方程：

$$
\frac{d \mu(t)}{d t}=0, \quad \mu(0)=\mu_{0}
$$

其中，$\mu(t)$是$t$温度时冰淇凌销量的期望值，而$0$摄氏度时，冰淇凌销量的期望为$\mu(0) = \mu_0$。

对以上方程，可以得到解$\mu(t)=\mu_{0}$。此外，我们还假设不同气温下，其他未知的影响销量的因素不发生变化，那么特定温度下的条件分布的方差是一个常数$\sigma$。

最后，我们假设观测值，或者说$t$气温下实际销量$y(t)$服从正态分布：

$$
y(t) \sim \mathcal{N}\left(\mu_{0}, \sigma^{2}\right)
$$

这个模型正确吗？从计算和推导上，没有任何问题。然而，任何人都知道气温是一定会影响冰淇凌销量的。所以，这样一个简单的模型显然无法让甜品店老板满意。

## 假设2:固定变化

固定变化是指，气温每变化1个单位，销量就会上升固定个单位。例如，从7摄氏度上升到9摄氏度，和从15摄氏度上升到17摄氏度，销量的变化量是相同的。用常微分方程来表示就是：

$$
\frac{d \mu(t)}{d t}=b, \quad \mu(0)=a
$$

对该方程求解，我们得到的是期望值与气温的线性关系：$\mu(t)=a+b t$

实际销量$y(t)$的分布为：

$$
y(t) \sim \mathcal{N}\left(\mu(t), \sigma^{2}\right)=\mathcal{N}\left(a+b t, \sigma^{2}\right)
$$

该模型就是一个一元线性回归模型，R中可以方便地对$a, b, \sigma$进行估计：

```S
lm(units ~ temp, data = ice_cream)
```

![Fig.2 固定变化模型的预测(蓝)](https://pic4.zhimg.com/80/v2-205c8875498fa5d6b830d8d97e5ad25c.png)

由图2可以看到，线性模型的拟合已经相当不错了。但冰淇凌店老板不太满意，因为模型告诉他，0摄氏度时销量是-160，这当然不是多要倒找给顾客好多冰淇凌！

看来，我们需要再换一个模型了。

## 假设3: 常增长率

常增长率是指，1个单位气温的增长，会带来固定百分比的销量增长。该假设表述为微分方程：

$$
\frac{d \mu(t)}{d t}=\mu(t) b, \quad \mu(0)=a
$$

> 注意，这里的$\mu(t)$仅代表$t$气温下销量的**中位数**，而不是均值。这和下面的对数处理和分布假设有关。

解该方程，得到：

$$
\mu(t)=a \exp (b t)
$$

对两边取对数，形式为：

$$
\log \mu(t)=\log a+b t
$$

上边也是一个线性模型。因此，我们可以假定对数尺度上的变化量和方差是恒定的，数据生成于这样一个过程：

$$
\log y(t) \sim \mathcal{N}\left(\log a+b t, \sigma^{2}\right)
$$

换句话说，我们认为$y(t)$生成于一个对数[正态分布](https://zh.wikipedia.org/wiki/对数正态分布)：

$$
y(t) \sim \mathcal{log_N}\left(\log a+b t, \sigma^{2}\right)
$$

对数正态分布有期望值:

$$
E[y(t)]=\exp(\log(\mu(t)) + \sigma^2/2) = \mu(t)\exp(\sigma^2/2)
$$

有标准差：

$$
\begin{aligned}
\operatorname{sd}[y(t)]&=\sqrt{\left(\exp(\sigma^2)-1\right)} \exp(\log \mu(t) + \sigma^2/2) \\
& = \sqrt{\left(\exp(\sigma^2)-1\right)} \mu(t)\exp(\sigma^2/2) 
\end{aligned}
$$

有中位数：

$$
\text{median}[y(t)] = \exp(\log \mu(t)) = \mu(t)
$$

不难发现，标准差比上期望值是一个常数，也就是说，该模型的一个潜藏假设是销量的标准差与期望值呈正比，这应该是比较合理的，因为销量越好的时节，销量波动性也的确会更高一些。

该模型也可以用一元线性回归模型进行估计：

```S
lm(log(units) ~ temp, data = ice_cream)
```

![Fig.3 常增长率的预测(蓝)](https://pic4.zhimg.com/80/v2-9a8330ea6b889efaef909f09103664dc.png)

需要注意，该模型的给出的预测值，是销量对数的期望值$E[\log(y(t))] = \log a + bt$，因此，作为对该值取指数还原后的结果，上图中的**蓝色曲线**是$\exp(\log a + bt) = \mu(t)$，即冰淇凌销量条件分布的**中位数**，而不是期望值，真正的期望值正如之前计算的那样，是$\mu(t)\exp(\sigma^2/2)$。

当我们将这个模型发给老板时，他又嫌这个模型有点过于乐观了，因为冰淇凌销量是一个指数增长！

## 假设4:固定需求弹性

弹性是一个经济学术语。当需求弹性固定为b=60%时，意味着温度上升10%，将导致销量增加6%。也就是说，销量增加的比例与气温上升的比例呈正比。用微分方程来表达就是：

$$
\frac{d \mu(t)}{\mu(t)}=b \frac{d t}{t}
$$

> 这里$\mu(t)$也是中位数，和假设3同理。

重新整理，并设$\mu(t)$初始值为$a$后，可以得到：

$$
\frac{d \mu(t)}{d t}=\frac{b}{t} \mu(t), \quad \mu(1)=a
$$

解为：

$$
\mu(t)=\exp (a+b \log (t))=\exp (a) \cdot t^{b}
$$

对两侧取对数，可以得到：

$$
\log (\mu(t))=a+b \log (t)
$$

也就是说，在log-log坐标下，销量$\mu(t)$和气温$t$之间的关系是一条直线。

所得模型为：

$$
\log y(t) \sim \mathcal{N}\left(a+b \log t, \sigma^{2}\right)
$$

也就是说，$y(t)$服从对数正态分布：

$$
y(t) \sim \mathcal{log_N}\left(\log a+b \log t, \sigma^{2}\right)
$$

该模型也可以用线性回归进行估计：

```
lm(log(units) ~ log(temp), data = ice_cream)
```

![Fig.4 固定需求弹性的预测(蓝)](https://pic4.zhimg.com/80/v2-0180125a7a1eff5d96a944a3b7cd9d98.png)

当我们将这个模型发给甜品店老板时，他已经相当满意了，但同时又指出了一个新问题，那就是我们的模型是无限增长的，但市场规模显然不是无上限的，如果能把这个问题再考虑在内，那就太好了！

## 假设5:固定市场规模

我们假设市场规模，或者说甜品销量的上限是$M$，且随时间的增长率会随着接近销量接近上限而逐渐变缓，就得到微分方程：

$$
\frac{d \mu(t)}{d t}=b \mu(t)(1-\mu(t) / M), \quad \mu(0)=\mu_{0}
$$

积分后得到逻辑斯蒂增长曲线：

$$
\mu(t)=\frac{\mu_{0} M e^{b t}}{\mu_{0}\left(e^{b t}-1\right)+M}
$$

然后我们假设观测值$y(t)$是从一个泊松分布中产生的：

$$
y(t) \sim \operatorname{Pois}(\mu(t))=\operatorname{Pois}\left(\frac{\mu_{0} M e^{b t}}{\mu_{0}\left(e^{b t}-1\right)+M}\right)
$$

但是，泊松分布的一个问题是均值等于方差，然而，显示世界的数据中，方差往往都会比均值大一些，所以，一个常用的技巧是将泊松分布调整为负二项分布，具体方法可以参考我之前的一篇文章[泊松回归及其拓展](https://zhuanlan.zhihu.com/p/480547435)。核心思想是将方差的形式由$\mu(t)$变为$=\mu(t)+\frac{\mu(t)^{2}}{\theta}$，这样通过调整$\theta$的大小，对离散程度进行控制。

这里使用R中的`bblme`包进行极大似然估计：
> [原文](https://www.magesblog.com/post/modelling-change/)这里用的是贝叶斯方法，使用软件包为`brms`，感兴趣的可以去看一下。我在之前的[在R中使用brms包进行贝叶斯推断](https://zhuanlan.zhihu.com/p/462086818)也介绍过一些简单的贝叶斯方法。

```S
# mu0 ： 0摄氏度时的销量
# M ： 市场规模上限，销量理论最大值
# b ： 初始增长率
# shape：负二项分布的theta
loss <- function(mu0, M, b, shape){
  mu <- mu0 * M * exp(b * ice_cream$temp) / (mu0 * (exp(b * ice_cream$temp) - 1) + M)
  sum(-dnbinom(x = ice_cream$units, mu = mu, size = shape, log = T))
}

start_vals <- list(mu0 = 10, b = 0.2, M = 800, shape = 70)

library(bbmle)
nb_model <- mle2(loss,
            start = start_vals, control = list(maxit = 2000))

summary(nb_model)
```

```
Maximum likelihood estimation

Call:
bbmle::mle2(minuslogl = loss, start = start_vals, control = list(maxit = 2000))

Coefficients:
        Estimate Std. Error    z value     Pr(z)    
mu0   1.5429e+01 5.5791e+00     2.7656  0.005682 ** 
M     6.3257e+02 6.0640e-01  1043.1633 < 2.2e-16 ***
b     2.3322e-01 2.3020e-02    10.1313 < 2.2e-16 ***
shape 1.7935e+02 7.9207e-03 22642.8255 < 2.2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

-2 log L: 119.0978 
```

![Image](https://pic4.zhimg.com/80/v2-1abfc74b34befc3fe6cd774d5cb27466.png)

M的估计值为632，这也是我们对市场上限的点估计。事实上，我感觉MLE对标准误的估计有些过于乐观了，可能这种小样本模型用贝叶斯方法更好一些。

